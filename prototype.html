<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zotero LLM Assistant</title>
    <style>
        :root {
            --bg: #f2efe7;
            --panel-bg: #faf7f0;
            --border: #b1a58a;
            --accent: #2b3a67;
            --accent-soft: #d7cfb8;
            --text-main: #222222;
            --text-muted: #6b6455;
            --user-bubble: #e2dcc5;
            --assistant-bubble: #ffffff;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 24px;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text-main);
            display: flex;
            justify-content: center;
        }

        .shell {
            width: 100%;
            max-width: 900px;
            border: 1px solid var(--border);
            background: var(--panel-bg);
            box-shadow: 0 12px 30px rgba(0,0,0,0.08);
            padding: 20px 24px 18px;
            position: relative;
        }

        .shell::before {
            content: "ZOTERO // REFERENCE TERMINAL";
            position: absolute;
            top: 6px;
            right: 10px;
            font-size: 10px;
            letter-spacing: 0.12em;
            color: var(--text-muted);
        }

        header {
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        header h1 {
            font-family: "Georgia", "Times New Roman", serif;
            font-size: 22px;
            margin: 0;
            letter-spacing: 0.04em;
        }

        header span {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: var(--text-muted);
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
            margin-bottom: 10px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 6px 14px;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: linear-gradient(to bottom, #fdfbf6, #f0e8d6);
            color: var(--accent);
            font-size: 12px;
            cursor: pointer;
        }

        .btn:hover {
            background: #f6f0df;
        }

        .status-pill {
            padding: 3px 10px;
            border-radius: 999px;
            border: 1px solid var(--accent-soft);
            background: #f5efe1;
            font-size: 11px;
        }

        .status-dot {
            display: inline-block;
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #3aa35c;
            margin-right: 6px;
        }

        .index-status {
            margin-top: 4px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .conversation {
            border-radius: 8px;
            border: 1px solid var(--accent-soft);
            background: rgba(255,255,255,0.7);
            padding: 10px 12px;
            max-height: 430px;
            overflow-y: auto;
            font-size: 14px;
        }

        .message {
            margin-bottom: 12px;
        }

        .message-label {
            font-size: 11px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 3px;
        }

        .message-bubble {
            border-radius: 6px;
            padding: 8px 10px;
            border: 1px solid var(--accent-soft);
            line-height: 1.45;
        }

        .message.user .message-bubble {
            background: var(--user-bubble);
        }

        .message.assistant .message-bubble {
            background: var(--assistant-bubble);
        }

        .answer-body p {
            margin: 0 0 6px;
        }

        .answer-body ul {
            padding-left: 18px;
            margin: 0 0 6px;
        }

        .answer-body li {
            margin-bottom: 2px;
        }

        .sources-strip {
            margin-top: 8px;
            border-top: 1px dashed var(--accent-soft);
            padding-top: 6px;
        }

        .sources-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .source-badge {
            display: inline-block;
            border-radius: 999px;
            border: 1px solid var(--accent-soft);
            padding: 3px 7px;
            margin: 2px 3px 0 0;
            font-size: 11px;
            cursor: pointer;
            background: #f8f3e6;
        }

        .source-badge:hover {
            background: #f0e8d7;
        }

        .snippet-list {
            margin-top: 8px;
            padding-top: 6px;
            border-top: 1px dashed var(--accent-soft);
        }

        .snippet-item {
            margin-top: 6px;
            font-size: 12px;
        }

        .snippet-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .prompt-area {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .prompt-input {
            flex: 1;
            padding: 7px 10px;
            border-radius: 100px;
            border: 1px solid var(--accent-soft);
            font-size: 14px;
            background: #fffdf7;
        }

        .prompt-input:focus {
            outline: 1px solid var(--accent);
        }

        .hint {
            margin-top: 4px;
            font-size: 11px;
            color: var(--text-muted);
        }

        code {
            font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            background: #f1ebdd;
            padding: 1px 3px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
<div class="shell">
    <header>
        <h1>Zotero LLM Assistant</h1>
        <span>reading room · beta</span>
    </header>

    <div class="toolbar">
        <div class="toolbar-left">
            <button class="btn" onclick="indexLibrary()">Index Zotero library</button>
            <div class="index-status" id="indexStatus">Not indexed yet.</div>
        </div>
        <div class="status-pill">
            <span class="status-dot"></span>Local model: llama3.2
        </div>
    </div>

    <div class="conversation" id="chatResults">
        <div class="message assistant">
            <div class="message-label">Assistant</div>
            <div class="message-bubble">
                Ask a question about your Zotero library to begin.
            </div>
        </div>
    </div>

    <div class="prompt-area">
        <input type="text" id="chatQuery" class="prompt-input"
               placeholder="Ask a question about your Zotero collection…" />
        <button class="btn" onclick="submitChat(event)">Send</button>
    </div>
    <div class="hint">Example: “Summarize the key arguments about digital archives in my library.”</div>
</div>

<script>
    function indexLibrary() {
        const statusEl = document.getElementById('indexStatus');
        statusEl.textContent = "Indexing library…";
        fetch('http://localhost:8000/index_library', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                statusEl.textContent = data.msg || data.error || "Indexing complete.";
            })
            .catch(() => {
                statusEl.textContent = "Error indexing library.";
            });
    }

    function submitChat(event) {
        if (event) event.preventDefault();
        const queryInput = document.getElementById('chatQuery');
        const query = queryInput.value.trim();
        if (!query) return;

        const convo = document.getElementById('chatResults');

        // Add user message
        const userHtml = `
            <div class="message user">
                <div class="message-label">You</div>
                <div class="message-bubble">${escapeHtml(query)}</div>
            </div>`;
        convo.insertAdjacentHTML('beforeend', userHtml);
        convo.scrollTop = convo.scrollHeight;

        // Add thinking placeholder
        const thinkingId = "thinking-" + Date.now();
        const thinkingHtml = `
            <div class="message assistant" id="${thinkingId}">
                <div class="message-label">Assistant</div>
                <div class="message-bubble"><span style="color:#999;">Thinking…</span></div>
            </div>`;
        convo.insertAdjacentHTML('beforeend', thinkingHtml);
        convo.scrollTop = convo.scrollHeight;

        fetch(`http://localhost:8000/chat?query=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                const thinkEl = document.getElementById(thinkingId);
                if (thinkEl) thinkEl.remove();

                if (data.error) {
                    addAssistantMessage(`<p>${escapeHtml(data.error)}</p>`);
                    return;
                }

                const { summary, citations, snippets } = data;

                // Format summary: convert double newlines to paragraphs, single to <br>
                const formattedSummary = formatSummary(summary || "");

                let answerHtml = `<div class="answer-body">${formattedSummary}</div>`;

                // Sources
                if (citations && citations.length) {
                    const sourceBadges = citations.map(c => `
                        <span class="source-badge"
                              title="Open in Zotero or PDF">
                            [${c.id}] ${escapeHtml(c.title || "Untitled")} (${c.year || 'n.d.'})
                        </span>
                    `).join(" ");
                    answerHtml += `
                        <div class="sources-strip">
                            <div class="sources-title">Sources</div>
                            ${sourceBadges}
                        </div>`;
                }

                // Snippets
                if (snippets && snippets.length) {
                    const snippetHtml = snippets.map(s => `
                        <div class="snippet-item">
                            <div class="snippet-meta">
                                [${s.citation_id}] ${escapeHtml(s.title || "Untitled")} (${s.year || 'n.d.'})
                            </div>
                            <div>${escapeHtml(s.snippet || "")}</div>
                        </div>
                    `).join("");
                    answerHtml += `
                        <div class="snippet-list">
                            <div class="sources-title">Supporting snippets</div>
                            ${snippetHtml}
                        </div>`;
                }

                addAssistantMessage(answerHtml);
                convo.scrollTop = convo.scrollHeight;
            })
            .catch(err => {
                const thinkEl = document.getElementById(thinkingId);
                if (thinkEl) thinkEl.remove();
                addAssistantMessage(`<p>There was a problem contacting the backend.</p><p><code>${escapeHtml(String(err))}</code></p>`);
            });

        queryInput.value = "";
    }

    function addAssistantMessage(htmlContent) {
        const convo = document.getElementById('chatResults');
        const msg = `
            <div class="message assistant">
                <div class="message-label">Assistant</div>
                <div class="message-bubble">
                    ${htmlContent}
                </div>
            </div>`;
        convo.insertAdjacentHTML('beforeend', msg);
    }

    function escapeHtml(str) {
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;");
    }

    function formatSummary(text) {
        if (!text) return "";
        const escaped = escapeHtml(text);

        // Split into paragraphs on double newline-like breaks
        const paragraphs = escaped.split(/\n\s*\n/);
        return paragraphs.map(p => {
            const withBreaks = p.replace(/\n/g, "<br>");
            return `<p>${withBreaks}</p>`;
        }).join("");
    }

    // Allow Enter to send
    document.getElementById('chatQuery').addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            submitChat(e);
        }
    });
</script>
</body>
</html>
